<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>동네 식당 등록/수정</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f5f6f8;
            font-family: 'Noto Sans KR', sans-serif;
        }
        .form-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.05);
            padding: 30px;
            max-width: 600px;
            margin: 50px auto;
        }
        .form-title {
            font-weight: 700;
            font-size: 1.4rem;
            margin-bottom: 25px;
            text-align: center;
        }
        .upload-box {
            border: 2px dashed #d0d0d0;
            border-radius: 10px;
            text-align: center;
            padding: 40px 0;
            color: #999;
            cursor: pointer;
            transition: border-color 0.2s;
            position: relative;
            overflow: hidden;  /* 이미지가 박스 밖으로 나가지 않게 */
            height: 220px;     /* 박스 높이 고정 */
        }
        .upload-box:hover {
            border-color: #00A2FF;
        }
        /*.upload-box img {*/
        /*    width: 64px;*/
        /*    opacity: 0.5;*/
        /*    margin-bottom: 10px;*/
        /*}*/

        /* 업로드 전 아이콘/텍스트 */
        .upload-icon {
            width: 64px;
            opacity: 0.6;
            margin-bottom: 10px;
            transition: opacity 0.2s;
        }
        .upload-text {
            font-size: 0.95rem;
        }

        /* 업로드 후 이미지가 박스를 채움 */
        .upload-box.uploaded img.preview-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 10px;
        }

        /* 업로드 후에는 아이콘과 텍스트 숨김 */
        .upload-box.uploaded .upload-icon,
        .upload-box.uploaded .upload-text {
            display: none;
        }

        input, textarea {
            border-radius: 8px !important;
        }
        textarea {
            resize: none;
            height: 120px;
        }
        .btn-primary {
            background-color: #00A2FF;
            border: none;
            width: 100%;
            border-radius: 8px;
            font-weight: 600;
        }
        .btn-primary:hover {
            background-color: #002349;
        }
        .form-label {
            font-weight: 600;
            margin-top: 15px;
        }
    </style>
</head>
<body>
<div th:replace="fragments/navbar :: navbar"></div>
<div class="form-card">
    <div class="form-title" th:text="${mode == 'create'} ? '식당 등록' : '식당 수정'"></div>

    <!-- 이미지 업로드 -->
    <div class="upload-box"
         onclick="document.getElementById('image-url').click()"
         th:classappend="${restaurant != null and restaurant.imageUrl != null} ? ' uploaded'">
        <img th:if="${restaurant != null and restaurant.imageUrl != null}"
             th:src="${restaurant.imageUrl}"
             class="preview-image"
             alt="menu image">
        <img th:if="${restaurant == null or restaurant.imageUrl == null}"
             id="preview"
             th:src="@{/images/icon-image-upload.png}"
             alt="upload icon" class="upload-icon">
        <p class="upload-text">이미지를 업로드하세요</p>
        <input type="file" id="image-url" accept="image/*" style="display:none" onchange="uploadAndPreviewImage(event)">
    </div>

    <input type="hidden" id="restaurant-id-aom" th:value="${restaurant.restaurantIdx}">

    <label class="form-label">식당 이름  <span style="color:#ef4444">*</span></label>
    <input type="text" class="form-control" id="name" placeholder="이름"
           th:value="${restaurant.name}">

    <label class="form-label">도로명 주소  <span style="color:#ef4444">*</span></label>
    <input type="text" class="form-control" id="road-address" placeholder="도로명 주소"
           th:value="${restaurant.roadAddress}">

    <label class="form-label">상세 주소  <span style="color:#ef4444">*</span></label>
    <input type="text" class="form-control" id="detail-address" placeholder="상세 주소"
           th:value="${restaurant.detailAddress}">

    <input type="hidden" class="form-control" id="longitude" th:value="${restaurant.longitude}">
    <input type="hidden" class="form-control" id="latitude" th:value="${restaurant.latitude}">

    <label class="form-label">오픈 시간  <span style="color:#ef4444">*</span></label>
    <input type="time" class="form-control" id="open-at"
           th:value="${restaurant.openAt}">

    <label class="form-label">폐점 시간  <span style="color:#ef4444">*</span></label>
    <input type="time" class="form-control" id="close-at"
           th:value="${restaurant.closeAt}">

    <label class="form-label">추가 설명</label>
    <textarea id="additional-info" class="form-control" placeholder="식당에 대한 추가 설명을 입력해주세요."
              th:text="${restaurant.additionalInfo}"></textarea>

    <input type="hidden" id="my-username" th:value="${restaurant.username}">

    <button class="btn btn-primary mt-4" onclick="submitMenu()"
            th:text="${mode == 'edit'} ? '수정 완료' : '등록 완료'">등록 완료</button>
</div>

<script>
    function initAutocomplete() {
        const input = document.getElementById("road-address");
        const options = {
            componentRestrictions: { country: "KR" },
            fields: ["formatted_address", "geometry", "name", "place_id"],
            strictBounds: false,
        };
        const autocomplete = new google.maps.places.Autocomplete(input, options);

        autocomplete.addListener('place_changed', () => {
            const place = autocomplete.getPlace();

            if (!place.place_id) {
                console.log("No details available for input: '" + place.name + "'");
                return;
            }

            const lat = place.geometry.location.lat();
            const lng = place.geometry.location.lng();

            document.getElementById("road-address").value = place.formatted_address;

            document.getElementById("latitude").value = Number(lat.toFixed(6));
            document.getElementById("longitude").value = Number(lng.toFixed(6));

            document.getElementById("detail-address").focus();

        });
    }

    async function submitMenu() {
        const requiredFields = ["name", "road-address", "detail-address", "longitude", "latitude", "open-at", "close-at"];
        for (let id of requiredFields) {
            const input = document.getElementById(id);
            if (!input.value.trim()) {
                alert("빈 값이 있습니다.");
                input.focus();
                return;
            }
        }

        const restaurantId = document.getElementById('restaurant-id-aom').value;
        const mode = restaurantId === '' ? 'create' : 'edit';

        // 기존 URL (수정 전)
        const oldImageUrl = /*[[${menuResponse != null ? menuResponse.imageUrl : ''}]]*/ '';

        // 현재 이미지 src
        const newImageUrl = document.querySelector('.preview-image')
            ? document.querySelector('.preview-image').src
            : '';

        const body = {
            name: document.getElementById("name").value,
            roadAddress: document.getElementById("road-address").value,
            detailAddress: document.getElementById("detail-address").value,
            longitude: Number(document.getElementById("longitude").value),
            latitude: Number(document.getElementById("latitude").value),
            openAt: document.getElementById("open-at").value,
            closeAt: document.getElementById("close-at").value,
            imageUrl: newImageUrl,
            additionalInfo: document.getElementById("additional-info").value
        };

        let url, method;
        if (mode === 'edit') {
            url = `/api/restaurants/${restaurantId}`;
            method = "PUT";
        } else {
            url = `/api/restaurants`;
            method = "POST";
            body["username"] = document.getElementById("my-username").value;
        }

        const res = await fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });

        if (res.ok) {
            // 기존 이미지와 새 이미지가 다를 경우 이전 이미지 삭제 요청
            if (mode === 'edit' && oldImageUrl && oldImageUrl !== newImageUrl) {
                await fetch(`/api/files/delete`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ imageUrl: oldImageUrl })
                });
            }

            alert(mode === 'edit' ? "메뉴 수정 완료!" : "메뉴 등록 완료!");
            window.location.href = mode === 'edit' ? `/restaurants/${restaurantId}` : `/restaurants`;
        } else {
            const errorText = await res.text();
            alert(mode+" 오류 발생: " + errorText);
        }
    }

    async function uploadAndPreviewImage(event) {
        const file = event.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append("file", file);

        // S3 업로드 요청
        const res = await fetch("/api/files/upload", {
            method: "POST",
            body: formData
        });

        if (!res.ok) {
            alert("이미지 업로드 실패!");
            return;
        }

        const imageUrl = await res.text();

        // 업로드 후 미리보기 표시
        const box = document.querySelector('.upload-box');
        const oldPreview = box.querySelector('.preview-image');
        if (oldPreview) oldPreview.remove();

        const img = document.createElement('img');
        img.src = imageUrl;
        img.classList.add('preview-image');
        box.appendChild(img);
        box.classList.add('uploaded');

        // hidden 이미지 경로 저장 (submitMenu에서 쓰임)
        document.getElementById("preview").setAttribute("src", imageUrl);
    }
</script>
<script async th:src="@{'https://maps.googleapis.com/maps/api/js?key=' + ${@environment.getProperty('google.maps.api.key')} + '&libraries=places&callback=initAutocomplete'}"></script>
</body>
</html>