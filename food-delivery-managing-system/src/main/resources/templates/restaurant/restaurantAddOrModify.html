<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>동네 식당 등록/수정</title>
</head>
<body>
    <div class="container">
        <a href="/restaurants">뒤로</a>
        <h1 th:if="${restaurant.restaurantIdx != null}">식당 수정</h1>
        <h1 th:if="${restaurant.restaurantIdx == null}">식당 등록</h1>
        <input type="hidden" id="restaurant-id-aom" th:value="${restaurant.restaurantIdx}">
        <form>
            <div>식당 이름  <span style="color:#ef4444">*</span></div>
            <input type="text" id="name" placeholder="이름" th:value="${restaurant.name}" required>
            <div>도로명 주소  <span style="color:#ef4444">*</span></div>
            <input type="text" id="road-address" placeholder="도로명 주소" th:value="${restaurant.roadAddress}" required>
            <div>상세 주소  <span style="color:#ef4444">*</span></div>
            <input type="text" id="detail-address" placeholder="상세 주소" th:value="${restaurant.detailAddress}" required>
            <div>좌표  <span style="color:#ef4444">*</span></div>
            <input type="number" id="longitude" placeholder="경도(-180~180)" th:value="${restaurant.coordinates?.x}" required>
            <input type="number" id="latitude" placeholder="위도(-90~90)" th:value="${restaurant.coordinates?.y}" required>
            <div>오픈 시간  <span style="color:#ef4444">*</span></div>
            <input type="time" id="open-at" th:value="${restaurant.openAt}" required>
            <div>폐점 시간  <span style="color:#ef4444">*</span></div>
            <input type="time" id="close-at" th:value="${restaurant.closeAt}" required>
            <div>대표 사진</div>
            <input type="file" id="image-url" placeholder="이미지 url"  accept="image/*" th:value="${restaurant.imageUrl}">
            <div>추가 정보</div>
            <textarea type="text" id="additional-info" placeholder="추가 정보" th:text="${restaurant.additionalInfo}"></textarea>
            <input type="hidden" id="my-username" th:value="${restaurant.username}">
            <br>
            <input th:if="${restaurant.restaurantIdx != null}" type="submit" id="modify-btn" value="수정">
            <input th:if="${restaurant.restaurantIdx == null}" type="submit" id="create-btn" value="등록">
        </form>
    <script>
        const modifyButton = document.getElementById("modify-btn");

        if(modifyButton){
            modifyButton.addEventListener('click', function(e) {
                e.preventDefault();
                const requiredFields = ["name", "road-address", "detail-address", "longitude", "latitude", "open-at", "close-at"];
                for (let id of requiredFields) {
                    const input = document.getElementById(id);
                    if (!input.value.trim()) {
                        alert("빈 값이 있습니다.");
                        input.focus();
                        return;
                    }
                }
                let restaurantId = Number(document.getElementById("restaurant-id-aom").value);
                fetch(`/api/restaurants/${restaurantId}`, {
                    method: 'PUT',
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        name: document.getElementById("name").value,
                        roadAddress: document.getElementById("road-address").value,
                        detailAddress: document.getElementById("detail-address").value,
                        longitude: Number(document.getElementById("longitude").value),
                        latitude: Number(document.getElementById("latitude").value),
                        openAt: document.getElementById("open-at").value,
                        closeAt: document.getElementById("close-at").value,
                        imageUrl: document.getElementById("image-url").value,
                        additionalInfo: document.getElementById("additional-info").value
                    })
                }).then((response) => {
                    if(response.ok){
                        alert("수정 완료");
                        location.replace(`restaurants/${restaurantId}`);
                    }
                    else alert(response.status+": 다시 시도해주세요.");
                })
            })
        }

        const createButton = document.getElementById("create-btn");

        if(createButton){
            createButton.addEventListener('click', function(e) {
                e.preventDefault();
                const requiredFields = ["name", "road-address", "detail-address", "longitude", "latitude", "open-at", "close-at"];
                for (let id of requiredFields) {
                    const input = document.getElementById(id);
                    if (!input.value.trim()) {
                        alert("빈 값이 있습니다.");
                        input.focus();
                        return;
                    }
                }
                fetch(`/api/restaurants`, {
                    method: 'POST',
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        name: document.getElementById("name").value,
                        roadAddress: document.getElementById("road-address").value,
                        detailAddress: document.getElementById("detail-address").value,
                        longitude: Number(document.getElementById("longitude").value),
                        latitude: Number(document.getElementById("latitude").value),
                        openAt: document.getElementById("open-at").value,
                        closeAt: document.getElementById("close-at").value,
                        imageUrl: document.getElementById("image-url").value,
                        additionalInfo: document.getElementById("additional-info").value,
                        username: document.getElementById("my-username").value
                    })
                }).then((response) => {
                    if(response.ok){
                        alert("등록 완료");
                        location.replace("/restaurants");
                    }
                    else alert(response.status+": 다시 시도해주세요.");
                })
            })
        }
    </script>
</body>
</html>