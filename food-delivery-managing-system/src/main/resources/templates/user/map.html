<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>내 주변 식당 Map</title>
  <script th:src="@{'https://maps.googleapis.com/maps/api/js?key=' + ${@environment.getProperty('google.maps.api.key')} + '&callback=initMap&libraries=maps,marker'}" async defer></script>
  <script>
    let map;
    let geocoder;
    let circles = {};

    async function initMap() {
      geocoder = new google.maps.Geocoder();

      const myPositionResponse = await fetch("/api/users/position");
      const myPosition = await myPositionResponse.json();

      const lat = Number((myPosition.latitude).toFixed(6));
      const lng = Number((myPosition.longitude).toFixed(6));
      const center = {lat: lat, lng: lng}; // 나의 주소 좌표

      map = new google.maps.Map(document.getElementById("map"), {
        center: center,
        zoom: 13,
        disableDefaultUI: true // Google Map 기본 UI 제거
      });

      // 3km 반경 표시
      circles[3000] = new google.maps.Circle({
        strokeColor: "#FF0000",
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: "#FF0000",
        fillOpacity: 0.1,
        center: center,
        radius: 3000,
        map: map,
        clickable: false
      });

      const myInfo = document.createElement("div");
      myInfo.style.position = "absolute";
      myInfo.style.cursor = "pointer";
      myInfo.className = "my-info";

      // 내 위치 고정 마커
      const coreCircle = document.createElement("div");
      coreCircle.className = "pulse-core";

      myInfo.appendChild(coreCircle);

      const fixPosition = new google.maps.LatLng(lat, lng);

      const myInfoOverlay = new google.maps.OverlayView();
      myInfoOverlay.onAdd = function () {
        this.getPanes().overlayMouseTarget.appendChild(myInfo);
      };

      // 커스텀으로 만든 마커 좌표에 고정
      myInfoOverlay.draw = function () {
        const projection = this.getProjection();
        const pos = projection.fromLatLngToDivPixel(fixPosition);
        if (pos) {
          myInfo.style.left = pos.x + "px";
          myInfo.style.top = pos.y + "px";
        }
      };

      myInfoOverlay.setMap(map);

      // 등록되어있는 가게 표시
      try {
        const response = await fetch("/api/users/restaurants");
        if (!response) throw new Error("식당 데이터 불러오기 실패");
        const restaurants = await response.json();

        class CustomMarker extends google.maps.OverlayView {
          constructor(position, map, store) {
            super();
            this.position = position;
            this.store = store;
            this.div = null;
            this.setMap(map);
          }

          onAdd() {
            this.div = document.createElement("div");
            this.div.style.position = "absolute";
            this.div.style.cursor = "pointer";

            // 이미지 + 스타일
            const img = document.createElement("img");
            img.src = this.store.imageUrl;
            img.alt = this.store.name;
            img.style.width = "50px";
            img.style.height = "50px";
            img.style.borderRadius = "50%";
            img.style.border = "2px solid white";
            img.style.boxShadow = "0 0 4px rgba(0,0,0,0.5)";

            this.div.appendChild(img);

            this.getPanes().overlayMouseTarget.appendChild(this.div);

            this.div.addEventListener("click", async () => {
              const menuResponse = await fetch(`/api/users/restaurants/${this.store.restaurantIdx}`);
              if (!menuResponse.ok) {
                throw new Error("메뉴 정보를 불러오지 못했음.");
              }
              const menus = await menuResponse.json();
              const menuList = document.getElementById("menu-list");
              menuList.innerHTML = ""; // 초기화 시켜주는 작업

              const infoBox = document.querySelector(".store-info");

              this.menus = menus;
              // 지도에서 특정 가게 클릭 시 지도 밑에 가게 정보 출력코드
              document.getElementById("store-name").textContent = this.store.name;
              document.getElementById("store-img").src = this.store.imageUrl;
              document.getElementById("store-openAt").textContent = this.store.openAt != null
                  ? `OPEN : ${this.store.openAt}` : "";
              document.getElementById("store-closeAt").textContent = this.store.closeAt != null
                  ? `CLOSE : ${this.store.closeAt}` : "";
              document.getElementById(
                  "store-restaurantRating").textContent = this.store.restaurantRating != null
                  ? `★ ${this.store.restaurantRating.toFixed(1)}` : "";

              if (this.menus != null && this.menus.length > 0) {
                this.menus.forEach(m => {
                  const menuDiv = document.createElement("div");
                  menuDiv.className = "menu-item";

                  const menuImg = document.createElement("img");
                  menuImg.src = m.imageUrl;
                  menuImg.alt = m.name;

                  const menuName = document.createElement("p");
                  menuName.textContent = m.name;

                  menuDiv.appendChild(menuImg);
                  menuDiv.appendChild(menuName);

                  menuList.appendChild(menuDiv);
                });
              } else {
                const emptyDiv = document.createElement("div");
                emptyDiv.className = "menu-item empty";
                emptyDiv.textContent = "등록된 메뉴가 없습니다.";
                menuList.appendChild(emptyDiv);
              }

              infoBox.style.display = "flex";

              infoBox.onclick = () => {
                window.location.href = `/restaurants/${this.store.restaurantIdx}`
              }
            });
          }

          draw() {
            const projection = this.getProjection();
            const pos = projection.fromLatLngToDivPixel(
                new google.maps.LatLng(this.position.lat, this.position.lng)
            );
            if (this.div) {
              this.div.style.left = pos.x - 25 + "px"; // 이미지 중심 기준
              this.div.style.top = pos.y - 25 + "px";
            }
          }
        }

        restaurants.forEach(store => {
          new CustomMarker({lat: store.latitude, lng: store.longitude}, map, store);
        });
      } catch (e) {
        console.error(e);
      }
    }
  </script>
  <style>
    /* 공통 초기화 */
    * {
      box-sizing: border-box;
      font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
      margin: 0;
      padding: 0;
    }

    body {
      background: #f5f7fa;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 40px 20px;
    }

    /* 지도 컨테이너 */
    /* 지도 영역 */
    .frame {
      position: relative;
      width: 100%;
      max-width: 960px;
      height: 600px;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.12);
      background: #eaeaea;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .map-info {
      width: 100%;
      max-width: 960px;
      background: white;
      padding: 14px 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .map-info h1 {
      font-size: 18px;
      font-weight: 600;
    }

    .store-info {
      display: flex;
      flex-direction: row;
      gap: 20px;
      padding: 24px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      max-width: 960px;
      width: 100%;
      align-items: stretch;
    }

    .store-left {
      width: 20%; /* 왼쪽 컬럼 폭 */
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .store-left img {
      width: 100%;
      height: 150px;
      border-radius: 12px;
      object-fit: cover;
    }

    .store-right {
      flex: 1; /* 남은 공간 채움 */
      display: flex;
      overflow-x: auto;
      justify-content: center;
      align-items: center;
      min-height: 100%;
      /*align-self: stretch;*/
    }

    .store-details {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1;
    }

    .store-name {
      font-size: 20px;
      font-weight: 700;
      color: #222;
    }

    .store-openCloseAt {
      font-size: 14px;
      color: #666;
    }

    .store-rating {
      font-size: 16px;
      color: #ffb400;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .menu-list {
      display: flex;
      flex-wrap: nowrap; /* 한 줄로 유지 */
      gap: 12px;
    }

    .menu-item {
      min-width: 120px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      text-align: center;
      padding: 8px;
      flex-shrink: 0;
    }

    .menu-item img {
      width: 100%;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
    }

    .menu-item p {
      font-size: 13px;
      margin-top: 6px;
      color: #333;
    }

    /* 메뉴가 없을 때 정가운데 */
    .menu-item.empty {
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 14px;
      color: #888;
      min-width: 0;
      flex: 1 1 auto;
      box-shadow: none;
      background: transparent;
    }

    /* 본인 위치 알려주는 마커 */
    .pulse-core {
      position: absolute;
      width: 14px;
      height: 14px;
      background-color: #007bff;
      border: 2px solid white;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      animation: glow 2.5s ease-in-out infinite;
    }

    @keyframes glow {
      0% {
        box-shadow: 0 0 10px 4px rgba(0, 123, 255, 0.8);
      }
      50% {
        box-shadow: 0 0 12px 10px rgba(0, 123, 255, 0.4);
      }
      100% {
        box-shadow: 0 0 10px 4px rgba(0, 123, 255, 0.8);
      }
    }

  </style>
</head>
<body>
<div class="map-info">
  <h1>내 주변 식당</h1>
</div>
<div class="frame" onload="initMap()">
  <div id="map"></div>
</div>
<!-- 가게 정보 영역 -->
<div class="store-info" style="width:100%; max-width:960px; margin-top:20px; display:none;">
  <div class="store-left">
    <img id="store-img" src="" alt="" style="width:120px; height:120px; border-radius:12px; object-fit:cover;">
    <div class="store-details">
      <h2 class="store-name" id="store-name"></h2>
      <p class="store-openCloseAt" id="store-openAt"></p>
      <p class="store-openCloseAt" id="store-closeAt"></p>
      <p class="store-rating" id="store-restaurantRating"></p>
    </div>
  </div>
  <div class="store-right">
    <div class="menu-list" id="menu-list"></div>
  </div>
</div>
</body>
</html>