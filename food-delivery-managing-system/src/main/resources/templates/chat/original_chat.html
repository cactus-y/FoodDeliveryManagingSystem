<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>채팅방</title>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        #messages { list-style-type: none; margin: 0; padding: 0; width: 100%; height: 300px; overflow-y: scroll; border: 1px solid #ddd; }
        #messages li { padding: 8px 12px; }
        #messages li:nth-child(odd) { background: #f2f2f2; }
        .sender { font-weight: bold; }
        .sentAt {
            display: block; margin-top: 4px;
            font-size: 0.6em; color: #888;
        }
    </style>
</head>
<body>
<h1>Chat Room #<span th:text="${chatId}"></span></h1>

<div id="messages">
</div>

<form id="messageForm" name="messageForm">
    <input type="text" id="messageInput" placeholder="Type your message here..." />
    <button type="submit">Send</button>
</form>

<script th:inline="javascript">
    /*<![CDATA[*/
    const chatId = /*[[${chatId}]]*/ 0;
    const currentUser = /*[[${currentUser}]]*/ null;

    const messages = document.getElementById('messages');
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');

    // 웹 사이트가 로드될 때 이전 메시지 로드
    document.addEventListener('DOMContentLoaded', function () {
        fetch(`/api/chats/${chatId}/messages`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                [header]: token
            }
        })
            .then(res => {
                if (!res.ok) {
                    throw new Error('이전 채팅 불러오기 실패');
                }
                return res.json();
            })
            .then(messages => {
                messages.forEach((message) => {
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message'
                    messageElement.innerHTML = `
                        <span class="sender">${message.sender.nickName}</span>: <span>${message.content}</span>
                        <span class="sentAt">${formatDate(new Date(message.sentAt))}</span>
                    `;
                    messages.appendChild(messageElement);
                });
            })
            .catch((error) => {
                console.log(error);
                alert(error.message);
            })
    });


    // Socket 관련 함수
    let stompClient = null;

    function connect() {
        const socket = new SockJS('/ws-stomp');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function(frame) {
            console.log(`Connected ${frame}`);

            stompClient.subscribe('/sub/chats/' + chatId, function(message) {
                const receivedMessage = JSON.parse(message.body);
                showMessage(receivedMessage);
            });
        });
    }

    function sendMessage(content) {
        stompClient.send("/pub/chats/messages",
            {},
            JSON.stringify({
                chatId: chatId,
                userId: currentUser.userId,
                content: content,
            })
        );
    }

    function showMessage(message) {
        console.log("show message: ", message);

        const messageElement = document.createElement('div');
        messageElement.className = 'message'
        messageElement.innerHTML = `
            <span class="sender">${message.sender.nickName}</span>: <span>${message.content}</span>
            <span class="sentAt">${formatDate(new Date(message.sentAt))}</span>
        `;
        messages.appendChild(messageElement);
        messages.scrollTop = messages.scrollHeight;
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        console.log('disconnected');
    }

    // XSS 공격 방지
    function escapeHtml(text) {
        if (!text) return '';
        return text
            .replace(/&/g, "&amp")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // 날짜 포매팅 함수
    function formatDate(date) {
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const hour = date.getHours();
        const minute = date.getMinutes();

        return `${year}년 ${month}월 ${day}일 ${hour}시 ${minute}분`;
    }

    // 메시지 전송
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = messageInput.value;
        if (message && stompClient) {
            sendMessage(escapeHtml(message));
            messageInput.value = '';
        }
    });

    connect();
    /*]]>*/
</script>
</body>